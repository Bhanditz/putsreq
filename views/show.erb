<script src="/js/ace.js"></script>
<script src="/js/ZeroClipboard.min.js"></script>
<script>
$(function(){
  var editor = ace.edit('editor');
  editor.setTheme('ace/theme/monokai');
  editor.getSession().setMode('ace/mode/javascript');
  editor.getSession().on('change', function(){
    $('#response_builder').val(editor.getSession().getValue());
  });

  editor.setValue($('#response-builder-container').text());
  editor.clearSelection();

  var client = new ZeroClipboard(document.getElementById('copy-puts_req-url'), { moviePath: '/js/ZeroClipboard.swf' });

  client.addEventListener('complete', function(client, text) {
    var previousTitle = $('#copy-puts_req-url').attr('title');
    $('#copy-puts_req-url').attr('title', 'Copied.');
    $('#copy-puts_req-url').tooltip('show');
    $('#copy-puts_req-url').attr('title', previousTitle);
   });
});
</script>
<ul class="nav">
  <li class="logo"><a href="/"><img src="/img/logo.png" /></a></li>
  <li><a href="<%= "/#{puts_req.token}/inspect" %>">Inspect</a></li>
  <li><a href="<%= "/#{puts_req.token}/last" %>">Last Request</a></li>
  <li><a href="<%= "/#{puts_req.token}/last_response" %>">Last Response</a></li>
</ul>

<strong>PutsReq URL</strong>
  <input type="text" value="<%= "#{request.url.gsub(request.path, '')}/#{puts_req.token}" %>"></input>
  <button id="copy-puts_req-url" data-clipboard-text="<%= "#{request.url.gsub(request.path, '')}/#{puts_req.token}" %> " title="Click to copy me." class="btn"><span class="glyphicon glyphicon-link"></span>copy</button>
</p>

<code>curl -i -X POST -H 'Content-Type: application/json' -d '{"message":"Hello World"}' <%= "#{request.url.gsub(request.path, '')}/#{puts_req.token}" %></code>
<form action="/<%= puts_req.token %>/post" method="post">
  <p><button class="btn"><span class="glyphicon glyphicon-camera"></span></button></p>
</form>
<hr/>


<form action="/<%= puts_req.token %>/response_builder" method="post">
  <script id="response-builder-container"  type='application/vns.putsreq-response_builder'><%= puts_req.response_builder %></script>
  <div id="editor" name="editor" style="width: 100%; height: 250px"></div>
  <textarea id="response_builder" name="response_builder" style="display:none;"></textarea>
  <p><button class="btn btn-primary tm10">Update</button></p>
</form>
<hr/>
<% puts_req.requests.to_a.each do |req| %>
  <table>
    <thead>
      <tr>
        <!--
        TODO: Show fields below:
        field :content_length
        field :request_method
        field :ip
        field :url
        field :params
        Check: http://requestb.in/t3ivtbt3?inspect
        -->
        <th>Header</th>
        <th>&nbsp;</th>
      </tr>
    </thead>
    <tbody>
    <% req.headers.to_h.each do |header_key, header_value| %>
      <tr>
        <td><%= header_key %></td>
        <td><%= header_value %></td>
      </tr>
    <% end %>
    </tbody>
  </table>
  <hr/>
  <table>
    <thead>
      <tr>
        <th>Request Body</th>
        <th>Response Body</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td><code><%= req.body %></code></td>
        <!-- TODO show response code and header -->
        <td><code><%= req.response.body_to_s.gsub('<', '&lt').gsub('>', '&gt') %></code></td>
      </tr>
    </tbody>
  </table>
  <hr/>
<% end %>
